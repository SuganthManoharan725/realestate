
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Properties</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .dimmed {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Add New Property</h2>
        <form id="propertyForm" action="http://localhost:5500/admin/upload" method="POST" enctype="multipart/form-data"> 
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="rate">Rate:</label>
                <input type="number" class="form-control" id="rate" name="rate" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="sqft">Square Footage:</label>
                <input type="number" class="form-control" id="sqft" name="sqft" required>
            </div>
            <div class="form-group">
                <label for="beds">Number of Beds:</label>
                <input type="number" class="form-control" id="beds" name="beds" required>
            </div>
            <div class="form-group">
                <label for="baths">Number of Baths:</label>
                <input type="number" class="form-control" id="baths" name="baths" required>
            </div>
            <div class="form-group">
                <label for="rating">Rating:</label>
                <input type="number" class="form-control" id="rating" name="rating" step="0.1" min="0" max="5" required>
            </div>
            <div class="form-group">
                <label for="booking">Booking Status:</label>
                <select class="form-control" id="booking" name="booking" required>
                    <option value="available">Available</option>
                    <option value="soldout">Sold Out</option>
                </select>
            </div>
            <div class="form-group">
                <label for="image">Image:</label>
                <input type="file" class="form-control-file" id="image" name="image" accept="image/*" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Property</button>
        </form>

        <hr>

        <h2>Manage Properties</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Rate</th>
                        <th>Square Footage</th>
                        <th>Beds</th>
                        <th>Baths</th>
                        <th>Rating</th>
                        <th>Booking Status</th>
                        <th>Image</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- Property rows will be appended here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        async function fetchProperties() {
            try {
                const response = await fetch('/properties');
                const properties = await response.json();
                const propertyTableBody = document.getElementById('propertyTableBody');

                properties.forEach(property => {
                    const row = `
                        <tr id="propertyRow_${property._id}" class="${property.booking === 'soldout' ? 'dimmed' : ''}">
                            <td><span id="title_${property._id}">${property.title}</span></td>
                            <td><span id="description_${property._id}">${property.description}</span></td>
                            <td><span id="rate_${property._id}">${property.rate}</span></td>
                            <td><span id="sqft_${property._id}">${property.sqft}</span></td>
                            <td><span id="beds_${property._id}">${property.beds}</span></td>
                            <td><span id="baths_${property._id}">${property.baths}</span></td>
                            <td><span id="rating_${property._id}">${property.rating}</span></td>
                            <td><span id="booking_${property._id}">${property.booking}</span></td>
                            <td><img src="/uploads/${property.image_path}" width="100"></td>
                            <td>
                                <button type="button" class="btn btn-danger" onclick="deleteProperty('${property._id}')">Delete</button>
                                <button type="button" class="btn btn-primary" onclick="editProperty('${property._id}')">Edit</button>
                                <button type="button" class="btn btn-success d-none" onclick="updateProperty('${property._id}')">Save</button>
                                <button type="button" class="btn btn-secondary d-none" onclick="cancelUpdate('${property._id}')">Cancel</button>
                            </td>
                        </tr>
                    `;
                    propertyTableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching properties:', error.message);
            }
        }

        async function deleteProperty(id) {
            try {
                const response = await fetch(`/admin/delete/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    document.getElementById(`propertyRow_${id}`).remove();
                } else {
                    alert('Error deleting property');
                }
            } catch (error) {
                console.error('Error deleting property:', error.message);
            }
        }

        function editProperty(id) {
            // Hide current span elements and show input fields for editing
            document.getElementById(`title_${id}`).innerHTML = `<input type="text" id="editTitle_${id}" value="${document.getElementById(`title_${id}`).textContent}">`;
            document.getElementById(`description_${id}`).innerHTML = `<textarea id="editDescription_${id}">${document.getElementById(`description_${id}`).textContent}</textarea>`;
            document.getElementById(`rate_${id}`).innerHTML = `<input type="number" step="0.01" id="editRate_${id}" value="${document.getElementById(`rate_${id}`).textContent}">`;
            document.getElementById(`sqft_${id}`).innerHTML = `<input type="number" id="editSqft_${id}" value="${document.getElementById(`sqft_${id}`).textContent}">`;
            document.getElementById(`beds_${id}`).innerHTML = `<input type="number" id="editBeds_${id}" value="${document.getElementById(`beds_${id}`).textContent}">`;
            document.getElementById(`baths_${id}`).innerHTML = `<input type="number" id="editBaths_${id}" value="${document.getElementById(`baths_${id}`).textContent}">`;
            document.getElementById(`rating_${id}`).innerHTML = `<input type="number" step="0.1" min="0" max="5" id="editRating_${id}" value="${document.getElementById(`rating_${id}`).textContent}">`;
            document.getElementById(`booking_${id}`).innerHTML = `
                <select id="editBooking_${id}">
                    <option value="available" ${document.getElementById(`booking_${id}`).textContent === 'available' ? 'selected' : ''}>Available</option>
                    <option value="soldout" ${document.getElementById(`booking_${id}`).textContent === 'soldout' ? 'selected' : ''}>Sold Out</option>
                </select>
            `;

            // Toggle button visibility for Save and Cancel
            document.querySelector(`#propertyRow_${id} .btn-primary`).classList.add('d-none');
            document.querySelector(`#propertyRow_${id} .btn-success`).classList.remove('d-none');
            document.querySelector(`#propertyRow_${id} .btn-secondary`).classList.remove('d-none');
        }

        function cancelUpdate(id) {
            // Restore original span elements content
            document.getElementById(`title_${id}`).innerHTML = document.getElementById(`editTitle_${id}`).value;
            document.getElementById(`description_${id}`).innerHTML = document.getElementById(`editDescription_${id}`).value;
            document.getElementById(`rate_${id}`).innerHTML = document.getElementById(`editRate_${id}`).value;
            document.getElementById(`sqft_${id}`).innerHTML = document.getElementById(`editSqft_${id}`).value;
            document.getElementById(`beds_${id}`).innerHTML = document.getElementById(`editBeds_${id}`).value;
            document.getElementById(`baths_${id}`).innerHTML = document.getElementById(`editBaths_${id}`).value;
            document.getElementById(`rating_${id}`).innerHTML = document.getElementById(`editRating_${id}`).value;
            document.getElementById(`booking_${id}`).innerHTML = document.getElementById(`editBooking_${id}`).value;

            // Toggle button visibility for Save and Cancel
            document.querySelector(`#propertyRow_${id} .btn-primary`).classList.remove('d-none');
            document.querySelector(`#propertyRow_${id} .btn-success`).classList.add('d-none');
            document.querySelector(`#propertyRow_${id} .btn-secondary`).classList.add('d-none');
        }

        async function updateProperty(id) {
            const updatedProperty = {
                title: document.getElementById(`editTitle_${id}`).value,
                description: document.getElementById(`editDescription_${id}`).value,
                rate: document.getElementById(`editRate_${id}`).value,
                sqft: document.getElementById(`editSqft_${id}`).value,
                beds: document.getElementById(`editBeds_${id}`).value,
                baths: document.getElementById(`editBaths_${id}`).value,
                rating: document.getElementById(`editRating_${id}`).value,
                booking: document.getElementById(`editBooking_${id}`).value
            };

            try {
                const response = await fetch(`/admin/update/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedProperty)
                });

                if (response.ok) {
                    // Update UI with new values
                    document.getElementById(`title_${id}`).textContent = updatedProperty.title;
                    document.getElementById(`description_${id}`).textContent = updatedProperty.description;
                    document.getElementById(`rate_${id}`).textContent = updatedProperty.rate;
                    document.getElementById(`sqft_${id}`).textContent = updatedProperty.sqft;
                    document.getElementById(`beds_${id}`).textContent = updatedProperty.beds;
                    document.getElementById(`baths_${id}`).textContent = updatedProperty.baths;
                    document.getElementById(`rating_${id}`).textContent = updatedProperty.rating;
                    document.getElementById(`booking_${id}`).textContent = updatedProperty.booking;

                    // Hide input fields and show spans
                    document.getElementById(`title_${id}`).innerHTML = updatedProperty.title;
                    document.getElementById(`description_${id}`).innerHTML = updatedProperty.description;
                    document.getElementById(`rate_${id}`).innerHTML = updatedProperty.rate;
                    document.getElementById(`sqft_${id}`).innerHTML = updatedProperty.sqft;
                    document.getElementById(`beds_${id}`).innerHTML = updatedProperty.beds;
                    document.getElementById(`baths_${id}`).innerHTML = updatedProperty.baths;
                    document.getElementById(`rating_${id}`).innerHTML = updatedProperty.rating;
                    document.getElementById(`booking_${id}`).innerHTML = updatedProperty.booking;

                    // Toggle button visibility for Save and Cancel
                    document.querySelector(`#propertyRow_${id} .btn-primary`).classList.remove('d-none');
                    document.querySelector(`#propertyRow_${id} .btn-success`).classList.add('d-none');
                    document.querySelector(`#propertyRow_${id} .btn-secondary`).classList.add('d-none');

                    // Apply dimming if the booking status is 'soldout'
                    if (updatedProperty.booking === 'soldout') {
                        document.getElementById(`propertyRow_${id}`).classList.add('dimmed');
                    } else {
                        document.getElementById(`propertyRow_${id}`).classList.remove('dimmed');
                    }
                } else {
                    alert('Error updating property');
                }
            } catch (error) {
                console.error('Error updating property:', error.message);
                alert('Error updating property');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchProperties(); // Fetch and display properties on page load
        });

    </script>
</body>
</html>


